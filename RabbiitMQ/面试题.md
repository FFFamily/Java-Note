**引入队列有啥优缺点，对比其他消息中间产品，选择这款的原因是啥**

优点：解耦系统、异步化、削峰

缺点: 系统可用性降低、复杂度增高、维护成本增高

选择原因

- 业务需求，整个系统的一个流程，吞吐是多少，什么样的对列能满足需求
- 部署成本，有时候也要考虑成本

主流消息队列Apache ActiveMQ、Kafka、RabbitMQ、RocketMQ

ActiveMQ：http://activemq.apache.org/

Apache出品，历史悠久，支持多种语言的客户端和协议，支持多种语言Java, .NET, C++ 等，

基于JMS Provider的实现

缺点：吞吐量不高，多队列的时候性能下降，存在消息丢失的情况，比较少大规模使用

Kafka：http://kafka.apache.org/

是由Apache软件基金会开发的一个开源流处理平台，由Scala和Java编写。Kafka是一种高吞

吐量的分布式发布订阅消息系统，它可以处理大规模的网站中的所有动作流数据(网页浏览，

搜索和其他用户的行动)，副本集机制，实现数据冗余，保障数据尽量不丢失；支持多个生产

者和消费者

缺点：不支持批量和广播消息，运维难度大，文档比较少, 需要掌握Scala

RabbitMQ：http://www.rabbitmq.com/

是一个开源的AMQP实现，服务器端用Erlang语言编写，支持多种客户端，如：Python、

Ruby、.NET、Java、JMS、C、用于在分布式系统中存储转发消息，在易用性、扩展性、高可

用性等方面表现不错

缺点：使用Erlang开发，阅读和修改源码难度大

RocketMQ：http://rocketmq.apach

阿里开源的一款的消息中间件, 纯Java开发，具有高吞吐量、高可用性、适合大规模分布式系

统应用的特点, 性能强劲(零拷贝技术)，支持海量堆积, 支持指定次数和时间间隔的失败消息重

发,支持consumer端tag过滤、延迟消息等，在阿里内部进行大规模使用，适合在电商，互联

网金融等领域使用

缺点：成熟的资料相对不多，社区处于新生状态但是热度高



**消息队列如何保证消息的可靠性传输吗**

消息可靠性传输，是非常重要，消息如果丢失，可能带来严重后果，一般从是个角度去分析 

producer端： 

不采用oneway发送，使用同步或者异步方式发送，做好重试，但是重试的Message key必须唯一 

投递的日志需要保存，关键字段，投递时间、投递状态、重试次数、请求体、响应体 

broker端： 

多主多从架构，需要多机房 

同步双写、异步刷盘 (同步刷盘则可靠性更高，但是性能差点，根据业务选择) 

机器断电重启：异步刷盘，消息丢失；同步刷盘消息不丢失 

硬件故障：可能存在丢失，看队列架构 

consumer端 

消息队列一般都提供的ack机制，发送者为了保证消息肯定消费成功，只有消费者明确表示消费成功，队 

列才会认为消息消费成功，中途断电、抛出异常等都不会认为成功——即都会重新投递，每次在确保处理完这个 

消息之后，在代码里调用ack，告诉消息队列消费成功 

消费端务必做好幂等性处理 

消息消费务必保留日志，即消息的元数据和消息体



**消息队列里面有没用过延迟消息，使用场景是怎样的**

什么是延迟消息： 

Producer 将消息发送到消息队列 broker服务端，但并不期望这条消息立马投递，而是推迟到在当前 

时间点之后的某一个时间投递到 Consumer 进行消费 

使用场景一：通过消息触发一些定时任务，比如在某一固定时间点向用户发送提醒消息 

使用场景二：消息生产和消费有时间窗口要求，比如在天猫电商交易中超时未支付关闭订单的场景，在订单创 

建时会发送一条 延时消息。这条消息将会在 30 分钟以后投递给消费者，消费者收到此消息后需要判断对应 

的订单是否已完成支付。 如支付未完成，则关闭订单。如已完成支付则忽略



**消息队列的发送方式有哪几种，使用场景分别是怎样的？**

发送方式一般分三种 

SYNC 同步发送 

应用场景：重要通知邮件、报名短信通知、营销短信系统等 

ASYNC 异步发送 

应用场景：对RT时间敏感,可以支持更高的并发，回调成功触发相对应的业务，比如注册成功后通知积分系统 

发放优惠券 

ONEWAY 无需要等待响应 

应用场景：主要是日志收集，适用于某些耗时非常短，但对可靠性要求并不高的场景, 也就是LogServer, 

只负责发送消息，不等待服务器回应且没有回调函数触发，即只发送请求 不等待应答。可能丢失消息



**线上消息队列故障了，消息堆积了几千万条，怎样快速处理**

线上故障了，怎么处理

消息堆积了10小时，有几千万条消息待处理，现在怎么办?

修复consumer, 然后慢慢消费？也需要几小时才可以消费完成，新的消息怎么办



核心思想：紧急临时扩容，更快的速度去消费数据 

\- 修复Consumer不消费问题，使其恢复正常消费，根据业务需要看是否要暂停 

\- 临时topic队列扩容，并提高消费者能力，但是如果增加Consumer数量，但是堆积的topic里面的 

message queue数量固定，过多的consumer不能分配到message queue 

\- 编写临时处理分发程序，从旧topic快速读取到临时新topic中，新topic的queue数量扩容多倍，然后再 

启动更多consumer进行在临时新的topic里消费 

\- 直到堆积的消息处理完成，再还原到正常的机器数量





