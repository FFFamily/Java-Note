# 主从复制

主机数据更新后根据配置和策略， 自动同步到备机的master/slaver机制，

**Master以写为主，Slave以读为主**

> 读写分离



## 作用

- 读写分离，提高性能
- 容灾快速恢复



## 配置

在配置文件中

```
daemonize yes // 设置为yes
```

- Pid文件名字pidfile
- 指定端口port
- Log文件名字
- dump.rdb名字dbfilename
- Appendonly 关掉或者换名字

例子

```properties
include /myredis/redis.conf
pidfile /var/run/redis_6379.pid
port 6379
dbfilename dump6379.rdb
```



按道理是每个服务器端口相同，ip不同而已，这里是测试模拟主从复制

设置从服务器

```properties
slaveof    ip      端口
slaveof 127.0.0.1 6379
```

  

## 特点

- 在主机上可以写，但是从机就不能写，会报错
- 当主机挂掉的时候，重启可以还原
- 当从机挂掉的时候，需要重新`slaveof`设置一下

> 当然可以加入到配置文件中，使其永久生效

- 当上一个Slare是下一个Slare的Master时，同样可以接收其他Slare的连接和同步请求

> 风险是一旦某个slave宕机，后面的slave都没法备份

- 当一个master宕机后，后面的slave可以立刻升为master，其后面的slave不用做任何修改

>  slaveof no one 将从机变成主机

> 复制原理
>
> Slave启动成功连接到master后会发送一个sync命令
>
> Master接到命令启动后台的存盘进程，同时收集所有接收到的用于修改数据集命令， 在后台进程执行完毕之后，master将传送整个数据文件到slave,以完成一次完全同步
>
> 全量复制：而slave服务在接收到数据库文件数据后，将其存盘并加载到内存中。
>
> 增量复制：Master继续将新的所有收集到的修改命令依次传给slave,完成同步
>
> 但是只要是重新连接master,一次完全同步（全量复制)将被自动执行



## 哨兵模式

我们不可能每次主机宏机了，都需要去手动的将从机变为主机，这个时候就需要一个监控，监控当有这样的情况发生时，会自动的帮我们做好这部分的操作



### 设置

- 创建**sentinel.conf** 文件
- 在配置文件中添加如下内容

```properties
sentinel monitor mymaster 127.0.0.1 6379 1
# 这个1代表当从机宏机数为1时执行
```

- 启动哨兵

> 在Redis的bin目录下有redis-sentinel可执行的文件
>
> ```
> redis-sentinel /redis/sentinel.conf
> ```



### 特点

- 当从机宏机后会根据优先级来确定谁会选举为主机

> slave-priority 

- 原主机重启后会变为从机



## 延时复制

由于所有的写操作都是先在Master上操作，然后同步更新到Slave上，所以从Master同步到Slave机器有一定的延迟，当系统很繁忙的时候，延迟问题会更加严重，Slave机器数量的增加也会使这个问题更加严重。



优先级在redis.conf中默认：slave-priority 100，值越小优先级越高

偏移量是指获得原主机数据最全的

每个redis实例启动后都会随机生成一个40位的runid