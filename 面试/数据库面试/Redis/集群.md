# 集群

在用户量巨大的网络世界，每秒的请求数都是巨大的

那么

Redis是如何处理庞大的并发写操作以及如何处理其容量过小的问题

Redis中的主从复制，导致了其ip地址随时可能会改变，那么应用程序中就很必须得去修改这个地址，显然是

科学的，所以 在redis3.0就中提供了解决方案。就是无中心化集群配置。



Redis 集群实现了对Redis的水平扩容，即启动N个redis节点，将整个数据库分布存储在这N个节点中，每个节点存储总数据的1/N。

Redis 集群通过分区（partition）来提供一定程度的可用性（availability）： 即使集群中有一部分节点失效或者无法进行通讯， 集群也可以继续处理命令请求。



**注意**

> 配置集群需要将持久化的数据删掉：即rbd和aof文件



## 配置

开启daemonize yes

Pid文件名字

指定端口

Log文件名字

Dump.rdb名字

Appendonly 关掉或者换名字

配置文件

```properties
cluster-enabled yes    打开集群模式
cluster-config-file nodes-6379.conf  设定节点配置文件名
cluster-node-timeout 15000   设定节点失联时间，超过该时间（毫秒），集群自动进行主从切换。
```

例子

```properties
include /home/bigdata/redis.conf
port 6379
pidfile "/var/run/redis_6379.pid"
dbfilename "dump6379.rdb"
dir "/home/bigdata/redis_cluster"
logfile "/home/bigdata/redis_cluster/redis_err_6379.log"
cluster-enabled yes
cluster-config-file nodes-6379.conf
cluster-node-timeout 15000
```

多复制几份，修改其端口号

> 一个集群至少要有三个主节点

启动

合成一个集群

进入Redis的src目录

执行

```properties
redis-cli --cluster create --cluster-replicas 1 192.168.11.101:6379 192.168.11.101:6380 192.168.11.101:6381 192.168.11.101:6389 192.168.11.101:6390 192.168.11.101:6391
```

注意

> 一定要是真实的ip
>
> --replicas 1 采用最简单的方式配置集群，一台主机，一台从机，正好三组。

登录

```
redis-cli -c -p 6379
# 需要加上-c，代表以集群的策略连接
```

查看信息

```
cluster nodes
```



## slots

一个 Redis 集群包含 16384 个插槽（hash slot）， 数据库中的每个键都属于这 16384 个插槽的其中一个， 

集群使用公式 CRC16(key) % 16384 来计算键 key 属于哪个槽， 其中 CRC16(key) 语句用于计算键 key 的 CRC16 校验和 。

集群中的每个节点负责处理一部分插槽。 举个例子， 如果一个集群可以有主节点， 其中：

节点 A 负责处理 0 号至 5460 号插槽。

节点 B 负责处理 5461 号至 10922 号插槽。

节点 C 负责处理 10923 号至 16383 号插槽。





- 在redis-cli每次录入、查询键值，redis都会计算出该key应该送往的插槽，如果不是该客户端对应服务器的插槽，redis会报错，并告知应前往的redis实例地址和端口。

- 不在一个slot下的键值，是不能使用mget,mset等多键操作。
- 可以通过{}来定义组的概念，从而使key中{}内相同内容的键值对放到一个slot中去。、
- CLUSTER GETKEYSINSLOT <slot><count> 返回 count 个 slot 槽中的键。